#!/usr/bin/env ruby
require 'yaml'
require 'fileutils'
require 'pry'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), "/../lib/duckula"))
require 'app'
require 'db_handler'
require 'docker_compose'
require 'engine'
require 'fetcher'
require 'quacker'

module Duckula  
  def build_apps(config_file)
    @configs = YAML.load_file(config_file).each_pair.map do |k,v|
      App.new(k,v)
    end
  end
  
  def setup_workspace(dir)
    FileUtils.mkdir_p(dir)
  end
  
end

include Duckula

root = `printf $PWD`
config_file = "#{root}/duckula/duckula.yml"
WORKING_DIR = "#{root}/duckula/tmp"
DUCKULA_DIR = "#{root}/duckula"

QUACKER = Duckula::Quacker.new

unless File.exist?(config_file)
  QUACKER.say "expected to find configuration file in #{config_file}"
  exit 1
end

docker_compose = DockerCompose.new
setup_workspace(WORKING_DIR)
apps = build_apps(config_file)
engine = Engine.new(apps, docker_compose)
engine.run(*ARGV)
