#!/usr/bin/env ruby
require 'yaml'
require 'fileutils'
require 'pry'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), "/../lib/duckula"))
require 'app'
require 'db_handler'
require 'docker_compose'
require 'engine'
require 'fetcher'
require 'quacker'
require 'runner'

module Duckula
  
end

include Duckula

root = `printf $PWD`
config_file = "#{root}/duckula/duckula.yml"
WORKING_DIR = "#{root}/duckula/tmp"
DUCKULA_DIR = "#{root}/duckula"

QUACKER = Duckula::Quacker.new

unless File.exist?(config_file)
  QUACKER.say "expected to find configuration file in #{config_file}"
  exit 1
end

FileUtils.mkdir_p(WORKING_DIR)

docker_compose = DockerCompose.new(Runner.new)
apps = YAML.load_file(config_file).each_pair.map do |k,v|
  App.new(k,v,docker_compose,DbHandler,Fetcher)
end
engine = Engine.new(apps, docker_compose)
engine.run(*ARGV)


# cases to deal with:
# - gems change in repo
# - initializer added